name: Denmark OSM-Bright Full Workflow

on:
  push:
    branches:
      - master
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
  pull_request:
    branches:
      - master
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  denmark-osm-bright:
    runs-on: ubuntu-latest
    env:
      IMAGE: ${{ github.repository_owner }}/docker-openstreetmap-tile-server
      TAG: ${{ github.sha }}
      BIQAPS_IMAGE: biqaps/openstreetmap:3.1
      DENMARK_OSM_DATA: denmark-osm-data
      DENMARK_STYLE: denmark-style
      DENMARK_TILES: denmark-tiles
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Build OSM-Bright Image
        run: |
          docker build -t ${{ env.BIQAPS_IMAGE }} .

      - name: Create Denmark Volumes
        run: |
          docker volume create ${{ env.DENMARK_OSM_DATA }}
          docker volume create ${{ env.DENMARK_STYLE }}
          docker volume create ${{ env.DENMARK_TILES }}

      - name: Import Denmark OSM Data with OSM-Bright Style
        run: |
          docker run --rm \
            -e STYLE_TYPE=osm-bright \
            -e DOWNLOAD_PBF=https://download.geofabrik.de/europe/denmark-latest.osm.pbf \
            -e DOWNLOAD_POLY=https://download.geofabrik.de/europe/denmark.poly \
            -e THREADS=4 \
            -v ${{ env.DENMARK_OSM_DATA }}:/data/database/ \
            -v ${{ env.DENMARK_STYLE }}:/data/style/ \
            ${{ env.BIQAPS_IMAGE }} import

      - name: Prerender Denmark Tiles (zoom 0-10)
        run: |
          docker run --rm \
            -e STYLE_TYPE=osm-bright \
            -e THREADS=4 \
            -v ${{ env.DENMARK_OSM_DATA }}:/data/database/ \
            -v ${{ env.DENMARK_STYLE }}:/data/style/ \
            -v ${{ env.DENMARK_TILES }}:/data/tiles/ \
            -v ${{ github.workspace }}/scripts:/scripts \
            --entrypoint bash \
            ${{ env.BIQAPS_IMAGE }} \
            -c "/scripts/prerender-tiles.sh 54.4 8.0 57.8 15.2 0 10"

      - name: Start Denmark OSM-Bright Tile Server
        run: |
          docker run --rm \
            -p 8080:80 \
            -e STYLE_TYPE=osm-bright \
            -v ${{ env.DENMARK_OSM_DATA }}:/data/database/ \
            -v ${{ env.DENMARK_STYLE }}:/data/style/ \
            -v ${{ env.DENMARK_TILES }}:/data/tiles/ \
            -d ${{ env.BIQAPS_IMAGE }} run
          sleep 30
          docker ps -a
          docker logs $(docker ps -q --filter ancestor=${{ env.BIQAPS_IMAGE }})

      - name: Download Example Tiles
        run: |
          curl http://localhost:8080/tile/0/0/0.png --fail -o 000.png
          curl http://localhost:8080/tile/1/0/0.png --fail -o 100.png
          curl http://localhost:8080/tile/1/0/1.png --fail -o 101.png
          curl http://localhost:8080/tile/1/1/0.png --fail -o 110.png
          curl http://localhost:8080/tile/1/1/1.png --fail -o 111.png
          curl http://localhost:8080/tile/10/138/85.png --fail -o empty.png
          curl http://localhost:8080/tile/10/135/89.png --fail -o example.png

      - name: Upload Tiles
        uses: actions/upload-artifact@v4
        with:
          name: tiles
          path: '*.png'

      - name: Cleanup Denmark Containers and Volumes
        run: |
          docker ps -a --filter volume=${{ env.DENMARK_OSM_DATA }} --filter volume=${{ env.DENMARK_STYLE }} --filter volume=${{ env.DENMARK_TILES }} -q | xargs -r docker rm -f
          docker volume rm -f ${{ env.DENMARK_OSM_DATA }} ${{ env.DENMARK_STYLE }} ${{ env.DENMARK_TILES }} || true
          docker rmi --force ${{ env.BIQAPS_IMAGE }}
